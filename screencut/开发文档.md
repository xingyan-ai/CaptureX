# ScreenCut 开发文档

## 1. 技术架构概述

### 1.1 技术栈
- **Manifest V3**: Chrome扩展最新规范
- **HTML5 + CSS3**: 用户界面
- **Vanilla JavaScript**: 核心逻辑（无额外框架依赖）
- **Canvas API**: 截图功能实现
- **Chrome Extension APIs**: 扩展功能支持

### 1.2 核心模块
```
screencut-extension/
├── manifest.json          # 扩展配置文件
├── popup/                 # 弹窗界面
│   ├── popup.html
│   ├── popup.css
│   └── popup.js
├── content/               # 内容脚本
│   ├── content.js
│   └── overlay.css
├── background/            # 后台脚本
│   └── background.js
├── utils/                 # 工具函数
│   ├── capture.js
│   └── ratio-calculator.js
├── icons/                 # 图标资源
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── README.md
```

## 2. 详细实现方案

### 2.1 Manifest配置
```json
{
  "manifest_version": 3,
  "name": "ScreenCut - 精准比例截图",
  "version": "1.0.0",
  "description": "为博客和公众号制作精准比例的截图工具",
  
  "permissions": [
    "activeTab",
    "scripting",
    "storage"
  ],
  
  "action": {
    "default_popup": "popup/popup.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  },
  
  "background": {
    "service_worker": "background/background.js"
  },
  
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content/content.js"],
      "css": ["content/overlay.css"]
    }
  ]
}
```

### 2.2 核心功能实现

#### 2.2.1 比例计算器 (utils/ratio-calculator.js)
```javascript
/**
 * 比例计算工具类
 * 负责处理1.75:1和2.35:1两种比例的尺寸计算
 */
class RatioCalculator {
  static RATIOS = {
    BLOG: { ratio: 1.75, name: '1.75:1 (博客)' },
    WECHAT: { ratio: 2.35, name: '2.35:1 (公众号)' }
  };
  
  static DEFAULT_WIDTH = 400; // 默认宽度
  
  /**
   * 根据比例和宽度计算高度
   */
  static calculateHeight(ratio, width) {
    return Math.round(width / ratio);
  }
  
  /**
   * 保持比例缩放
   */
  static scaleWithRatio(currentWidth, currentHeight, targetWidth, ratio) {
    const newHeight = this.calculateHeight(ratio, targetWidth);
    return { width: targetWidth, height: newHeight };
  }
}
```

#### 2.2.2 截图框组件 (content/content.js 核心部分)
```javascript
/**
 * 截图框类 - 负责在页面上绘制可交互的截图框
 */
class ScreenshotOverlay {
  constructor(ratio) {
    this.ratio = ratio;
    this.isActive = false;
    this.isDragging = false;
    this.isResizing = false;
    
    this.createOverlay();
    this.bindEvents();
  }
  
  /**
   * 创建截图框DOM结构
   */
  createOverlay() {
    // 创建遮罩层
    this.overlay = document.createElement('div');
    this.overlay.className = 'screencut-overlay';
    
    // 创建截图框
    this.frame = document.createElement('div');
    this.frame.className = 'screencut-frame';
    
    // 创建控制点
    this.createResizeHandles();
    
    // 创建信息面板
    this.createInfoPanel();
    
    this.overlay.appendChild(this.frame);
    document.body.appendChild(this.overlay);
  }
  
  /**
   * 创建四个角的缩放控制点
   */
  createResizeHandles() {
    const positions = ['nw', 'ne', 'sw', 'se'];
    this.handles = {};
    
    positions.forEach(pos => {
      const handle = document.createElement('div');
      handle.className = `screencut-handle screencut-handle-${pos}`;
      handle.dataset.position = pos;
      this.handles[pos] = handle;
      this.frame.appendChild(handle);
    });
  }
}
```

#### 2.2.3 截图捕获 (utils/capture.js)
```javascript
/**
 * 截图捕获工具
 * 使用html2canvas库或Canvas API实现截图功能
 */
class ScreenCapture {
  /**
   * 捕获指定区域的截图
   * @param {Object} bounds - 截图区域 {x, y, width, height}
   * @param {number} ratio - 图片比例
   */
  static async captureArea(bounds, ratio) {
    try {
      // 创建canvas元素
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // 设置canvas尺寸（考虑设备像素比）
      const devicePixelRatio = window.devicePixelRatio || 1;
      canvas.width = bounds.width * devicePixelRatio;
      canvas.height = bounds.height * devicePixelRatio;
      
      // 使用html2canvas捕获页面内容
      const screenshot = await html2canvas(document.body, {
        x: bounds.x,
        y: bounds.y,
        width: bounds.width,
        height: bounds.height,
        scale: devicePixelRatio,
        useCORS: true,
        allowTaint: false
      });
      
      return screenshot.toDataURL('image/png');
    } catch (error) {
      console.error('截图失败:', error);
      throw new Error('截图失败，请重试');
    }
  }
  
  /**
   * 下载图片到本地
   */
  static downloadImage(dataUrl, filename = 'screencut-image.png') {
    const link = document.createElement('a');
    link.download = filename;
    link.href = dataUrl;
    link.click();
  }
  
  /**
   * 复制图片到剪贴板
   */
  static async copyToClipboard(dataUrl) {
    try {
      const response = await fetch(dataUrl);
      const blob = await response.blob();
      
      await navigator.clipboard.write([
        new ClipboardItem({ 'image/png': blob })
      ]);
      
      return true;
    } catch (error) {
      console.error('复制到剪贴板失败:', error);
      return false;
    }
  }
}
```

### 2.3 用户界面实现

#### 2.3.1 弹窗界面 (popup/popup.html)
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="popup-container">
    <div class="header">
      <h1>ScreenCut</h1>
      <p>精准比例截图工具</p>
    </div>
    
    <div class="ratio-selector">
      <button class="ratio-btn" data-ratio="1.75">
        <span class="ratio-text">1.75:1</span>
        <span class="ratio-desc">博客横幅</span>
      </button>
      <button class="ratio-btn" data-ratio="2.35">
        <span class="ratio-text">2.35:1</span>
        <span class="ratio-desc">公众号封面</span>
      </button>
    </div>
    
    <div class="actions">
      <button id="startCapture" class="btn-primary">开始截图</button>
      <button id="cancel" class="btn-secondary">取消</button>
    </div>
  </div>
  
  <script src="popup.js"></script>
</body>
</html>
```

#### 2.3.2 Linear风格样式 (popup/popup.css)
```css
/* Linear极简设计风格 */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  width: 280px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #ffffff;
  color: #1a1a1a;
}

.popup-container {
  padding: 20px;
}

.header h1 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 4px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header p {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 20px;
}

.ratio-selector {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
}

.ratio-btn {
  flex: 1;
  padding: 16px 12px;
  border: 1.5px solid #e5e7eb;
  border-radius: 8px;
  background: #ffffff;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
}

.ratio-btn:hover {
  border-color: #3b82f6;
  background: #f8fafc;
}

.ratio-btn.active {
  border-color: #3b82f6;
  background: #eff6ff;
}

.ratio-text {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #1a1a1a;
  margin-bottom: 2px;
}

.ratio-desc {
  display: block;
  font-size: 11px;
  color: #6b7280;
}

.actions {
  display: flex;
  gap: 8px;
}

.btn-primary {
  flex: 1;
  padding: 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s ease;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-secondary {
  padding: 12px 16px;
  background: #f8fafc;
  color: #6b7280;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-secondary:hover {
  background: #f1f5f9;
  color: #475569;
}
```

## 3. 开发流程

### 3.1 环境准备
1. **开发工具**: VS Code + Chrome浏览器
2. **调试**: Chrome开发者工具 > 扩展程序页面
3. **测试**: 本地加载未打包的扩展进行测试

### 3.2 开发步骤
1. **第一阶段**: 基础框架搭建
   - 创建manifest.json
   - 实现popup基础界面
   - 建立content script通信

2. **第二阶段**: 截图框功能
   - 实现截图框绘制
   - 添加拖拽和缩放功能
   - 比例计算逻辑

3. **第三阶段**: 截图核心功能
   - 集成html2canvas库
   - 实现截图捕获
   - 添加下载和复制功能

4. **第四阶段**: 优化完善
   - UI细节调优
   - 错误处理
   - 性能优化

### 3.3 关键技术要点

#### 消息通信
```javascript
// popup -> content script
chrome.tabs.sendMessage(tabId, {
  action: 'startCapture',
  ratio: selectedRatio
});

// content script -> popup
chrome.runtime.sendMessage({
  action: 'captureComplete',
  imageData: base64Data
});
```

#### 权限处理
```javascript
// 检查必要权限
const permissions = await chrome.permissions.contains({
  permissions: ['activeTab']
});
```

## 4. 测试方案

### 4.1 功能测试
- 比例计算准确性测试
- 截图框交互测试
- 截图质量测试
- 跨浏览器兼容性测试

### 4.2 性能测试
- 大页面截图性能
- 内存使用情况
- 启动速度测试

## 5. 部署说明

### 5.1 本地安装
1. 打开Chrome浏览器
2. 访问 `chrome://extensions/`
3. 开启"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目文件夹

### 5.2 打包发布（如需要）
```bash
# 压缩为zip文件
zip -r screencut-extension.zip screencut-extension/ -x "*.git*" "node_modules/*"
```

## 6. 维护更新

### 6.1 版本管理
- 遵循语义化版本号 (Semantic Versioning)
- 更新manifest.json中的版本号
- 记录更新日志

### 6.2 问题排查
- 查看Chrome扩展程序错误日志
- 使用console.log进行调试
- 检查权限和API调用

---

**注意**: 本文档会随着开发进度持续更新，请定期查看最新版本。 