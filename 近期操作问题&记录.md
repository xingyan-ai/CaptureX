# 近期操作问题 & 记录

## 1. 需求理解与初始实现

- **问题描述**: 用户要求在现有截图工具中增加自定义尺寸功能，包括保存、删除和不同类型的截图行为（固定比例可缩放，固定像素不可缩放）。
- **解决方案**: 
    1.  创建 `扩展需求.md` 文档，明确需求。
    2.  修改 `popup.html` 增加自定义尺寸UI。
    3.  修改 `popup.css` 适配新UI样式。
    4.  修改 `popup.js` 实现自定义尺寸的增删改查和与 `content.js` 的通信逻辑。
    5.  修改 `content.js` 适配新的尺寸配置对象，并根据类型控制截图框行为。
    6.  修改 `background.js` 转发 `popup.js` 和 `content.js` 之间的消息。
- **结果**: 首次尝试后，用户反馈截图功能完全失效。

## 2. 脚本注入失败 (chrome:// URL)

- **问题描述**: 用户反馈 `background.js:35 Error sending message to content script: Could not establish connection. Receiving end does not exist.` 错误，截图失败。
- **诊断**: `background.js` 尝试向 `content.js` 发送消息时，`content.js` 尚未加载到页面中。旧版本 `background.js` 包含动态注入逻辑，但新版本被简化后移除了。
- **解决方案**: 
    1.  检查 `manifest.json` 权限，确认 `scripting` 权限存在。
    2.  在 `manifest.json` 中添加 `host_permissions: ["<all_urls>"]` 以允许在所有页面注入脚本。
    3.  恢复 `background.js` 中在消息发送失败时动态注入 `html2canvas.min.js` 和 `content.js` 的逻辑。
- **结果**: 修复了 `Could not establish connection` 错误，但出现了新的错误 `Script injection failed: Error: Cannot access a chrome:// URL`。

## 3. 脚本注入失败 (chrome-extension:// URL)

- **问题描述**: 用户反馈 `Script injection failed: Error: Cannot access a chrome-extension:// URL of different extension` 错误，截图失败。
- **诊断**: Chrome 扩展程序出于安全原因，禁止在 `chrome://` 和 `chrome-extension://` 等特殊URL上注入脚本。之前的修复只处理了 `chrome://`，未处理 `chrome-extension://`。
- **解决方案**: 
    1.  更新 `background.js`，在注入脚本前增加对 `tab.url` 的检查，如果检测到 `chrome://` 或 `chrome-extension://` URL，则阻止注入并返回友好错误信息。
- **结果**: 解决了在特殊URL上注入失败的问题，但用户反馈“截图框显示不出来，下面的那几个按钮都消失了，没办法取消。然后比例的也没有办法放大缩小”。

## 4. 截图框UI元素缺失与功能异常

- **问题描述**: 截图框能出现，但工具栏按钮（下载、复制、取消）消失，且比例截图无法缩放（缺少缩放手柄）。
- **诊断**: 
    1.  `content.js` 在创建DOM元素时，使用的CSS类名可能与 `content/overlay.css` 中定义的样式不匹配。
    2.  `content.js` 中控制缩放手柄显示的逻辑可能存在问题。
- **解决方案**: 
    1.  读取 `content/overlay.css` 确认正确的类名和样式。
    2.  修正 `content.js` 中 `createToolbar` 和 `createDOM` 函数，确保工具栏按钮和缩放手柄使用正确的CSS类名，并根据 `state.isResizable` 正确创建缩放手柄。
- **结果**: 用户反馈“现在截图框出现不了。要注意一个页面不刷新的情况下我会截图多次，可能用不同的尺寸”。

## 5. 多次截图导致的状态混乱

- **问题描述**: 用户反馈“现在截图框出现不了”，并强调“一个页面不刷新的情况下我会截图多次，可能用不同的尺寸”。
- **诊断**: 怀疑 `popup.js` 在多次截图之间，状态管理不当，导致 `selectedConfig` 对象被污染，传递给 `content.js` 的数据不正确，从而无法正确创建截图框。
- **解决方案**: 
    1.  **重构 `popup.js` 的 `selectRatio` 函数**：确保每次选择尺寸时，都创建一个全新的、纯净的 `selectedConfig` 对象，并严格校验其数据有效性，防止数据污染。
    2.  **增强 `content.js` 的校验**：在 `content.js` 的 `initialize` 函数中，增加对 `dimensions` 宽高的 `isNaN` 检查，确保尺寸有效。
- **结果**: 用户反馈“ScreenCut Background Service Worker loaded. background.js:49 Content script not found, injecting now... background.js:54 Scripts injected, retrying message...”，截图框依然出不来。

## 6. 脚本重复注入与生命周期问题 (单例模式)

- **问题描述**: 尽管日志显示脚本注入成功，但截图框仍未出现，且用户强调多次截图场景。
- **诊断**: 怀疑 `content.js` 脚本在页面上被意外地多次注入或执行，导致其内部状态混乱，最终无法创建截图框。这是一种深层的脚本生命周期问题。
- **解决方案**: 
    1.  **在 `content.js` 中实现“单例模式”**：在 `content.js` 的最外层增加一个 `window.hasScreenCutInitialized` 标记。如果标记不存在，则初始化所有逻辑并设置标记；如果标记已存在，则不重复初始化，只处理消息监听。这确保了 `content.js` 的核心逻辑只执行一次。
    2.  **简化 `background.js`**：由于 `content.js` 现在是单例，`background.js` 可以简化为每次都尝试注入脚本，而无需复杂的错误处理和重试逻辑。
- **结果**: 正在等待用户验证。
